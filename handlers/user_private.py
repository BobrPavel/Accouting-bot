# --------------------------------------------------------------------------------
# –ú–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥ –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤
# --------------------------------------------------------------------------------
# –ò–º–ø–æ—Ä—Ç—ã
# --------------------------------------------------------------------------------

from dataclasses import dataclass
from io import BytesIO
import mimetypes
import os

from aiogram import types, Router
from aiogram.filters import Command, CommandStart
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup



# --------------------------------------------------------------------------------
# –î–∞—Ç–∞ –∫–ª–∞—Å—Å—ã
# --------------------------------------------------------------------------------


@dataclass
class Bank_customer:
    """–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∑–∞–∫–∞–∑—á–∏–∫–∞"""
    name: str  # –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞
    BIC: str  # –ë–ò–ö
    current_account: str  # —Ä–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç
    corporate_account: str  # –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á—ë—Ç


@dataclass
class Bank_executor:
    """–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"""
    name: str  # –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞
    BIC: str  # –ë–ò–ö
    current_account: str  # —Ä–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç
    corporate_account: str  # –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á—ë—Ç


@dataclass
class Executor:
    """–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å"""
    name: str  # –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞, –Ω–∞–ø—Ä–∏–µ–º–µ—Ä, –û–û–û ¬´–†–æ–≥–∞ –∏ –∫–æ–ø—ã—Ç–∞¬ª
    INN: str  # –ò–ù–ù
    OGRN: str  # –û–ì–†–ù –∏–ª–∏ –û–ì–†–ù–ò–ü
    address: str  # —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
    signatory: str  # –ø–æ–¥–ø–∏—Å–∞–Ω—Ç
    bank: Bank_customer  # –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∑–∞–∫–∞–∑—á–∏–∫–∞

@dataclass
class Customer:
    """–ó–∞–∫–∞–∑—á–∏–∫"""
    name: str  # –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞, –Ω–∞–ø—Ä–∏–µ–º–µ—Ä, –û–û–û ¬´–†–æ–≥–∞ –∏ –∫–æ–ø—ã—Ç–∞¬ª
    INN: str  # –ò–ù–ù
    OGRN: str  # –û–ì–†–ù –∏–ª–∏ –û–ì–†–ù–ò–ü
    address: str  # —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
    signatory: str  # –ø–æ–¥–ø–∏—Å–∞–Ω—Ç
    bank: Bank_executor  # –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∑–∞–∫–∞–∑—á–∏–∫–∞


@dataclass
class Job:
    task: str  # –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞
    price: int  # —Ü–µ–Ω–∞ –∑–∞ –∑–∞–¥–∞—á—É


# --------------------------------------------------------------------------------
# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–≥–µ–Ω—Ç–∞
# --------------------------------------------------------------------------------


# --------------------------------------------------------------------------------
# –ê–≥–µ–Ω—Ç
# --------------------------------------------------------------------------------




# --------------------------------------------------------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# --------------------------------------------------------------------------------


user_private_router = Router()

TYPST_BIN = os.path.join("typst", "typst.exe")

SYSTEM_PROMPT = (
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ —Å–ø—Ä–æ—Å–∏—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ –æ–Ω —Ö–æ—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ‚Äî –∞–∫—Ç –∏–ª–∏ —Å—á—ë—Ç –∏–ª–∏ –æ–±–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞. "
        "–ó–∞—Ç–µ–º –Ω—É–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç –∏–ª–∏ —Å—á—ë—Ç, –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ–±–µ –Ω–∞–¥–æ –≤–∑—è—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã "
        "–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –∏–∑ –ø–∞–º—è—Ç–∏. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ó–∞–ø—Ä–æ—Å–∏ —Ä–∞–±–æ—Ç—ã –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ "
        "–∞–∫—Ç (–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á –∏ –∏—Ö —Å—Ç–æ–∏–º–æ—Å—Ç—å), —Ä–∞–±–æ—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ. "
        "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑—ã–≤–∞–µ—Ç –≤ –∫–∞—á–µ—Ç—Å–≤–µ —Ä–∞–±–æ—Ç—ã –∫—É—Ä—Å, —Ç–æ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±–µ—Ä—ë–º –æ–¥–Ω—É —Ä–∞–±–æ—Ç—É, –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ç–∞–∫—É—é "
        "\"–û–±—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ –∫—É—Ä—Å–µ ¬´–•–∞—Ä–¥–∫–æ—Ä–Ω–∞—è –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞¬ª\", —Å—Ç–æ–∏–º–æ—Å—Ç—å—é 170 —Ç—ã—Å —Ä—É–±."
        "–ù–∏–∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π, –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ —Å—Ç—Ä–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∏ —É "
        "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –†–µ–∫–≤–∏–∑–∏—Ç—ã —É–∂–µ –µ—Å—Ç—å –≤ –ø–∞–º—è—Ç–∏ –∏ –ø–µ—Ä–µ–¥–∞–Ω—ã —Ç–µ–±–µ."
        "–ò–º—è –∏ –æ—Ç—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞ —Å–æ–∫—Ä–∞—â–∞–µ–º –¥–æ –æ–¥–Ω–æ–π –ø–µ—Ä–≤–æ–π –±—É–∫–≤—ã, "
        "–Ω–∞–ø—Ä–∏–º–µ—Ä, –ò–≤–∞–Ω–æ–≤ –ê.–ï. "
        "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –∫–∞–≤—ã—á–∫–∏ —ë–ª–æ—á–∫–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä, "
        "–û–û–û ¬´–†–æ–≥–∞ –∏ –∫–æ–ø—ã—Ç–∞¬ª, —Ç–æ –µ—Å—Ç—å –¥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ —Å—Ç–∞–≤–∏–º ¬´ –∏ –ø–æ—Å–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è "
        "—Å—Ç–∞–≤–∏–º ¬ª."
    )


# --------------------------------------------------------------------------------
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞
# --------------------------------------------------------------------------------





# --------------------------------------------------------------------------------
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
# --------------------------------------------------------------------------------


@user_private_router.message(CommandStart())
async def start_cmd(message: types.Message, state: FSMContext):
    await message.answer("–ü—Ä–∏–≤–µ—Ç—Å–≤—É—é! –Ø –±–æ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–∫—Ç–æ–≤ –∏ —Å—á–µ—Ç–æ–≤. –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–∞–π–ª —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è")
    await state.set_state(ReqFiles.waiting_my_file)


@user_private_router.message(Command("new"))
async def new_document(message: types.Message, state: FSMContext):
    await state.clear()
    await message.answer("–ó–∞–±—ã–ª –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è")
    await state.set_state(ReqFiles.waiting_my_file)


# --------------------------------------------------------------------------------
# FSM –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏
# --------------------------------------------------------------------------------


class ReqFiles(StatesGroup):
    waiting_my_file = State()
    waiting_client_file = State()
    chatting = State()


@user_private_router.message(F.document)
async def handle_file(message: types.Message, state: FSMContext, bot):
    current_state = await state.get_state()

    doc = message.document
    file_id = doc.file_id
    file_name = doc.file_name

    mime_type, _ = mimetypes.guess_type(file_name)
    if not mime_type:
        mime_type = "application/octet-stream"


    # –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
    if current_state == ReqFiles.waiting_my_file.state:
        next_state = ReqFiles.waiting_client_file
        prompt = "–§–∞–π–ª —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω! üéâ \n–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –∑–∞–∫–∞–∑—á–∏–∫–∞."

    elif current_state == ReqFiles.waiting_client_file.state:
        next_state = ReqFiles.chatting
        prompt = "–§–∞–π–ª —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∑–∞–∫–∞–∑—á–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω! üéâ"

    else:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —Å —Ä–µ–≤–∏–∑–∏—Ç–∞–º–∏")
        return

    # ---- –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç—å ----
    buffer = BytesIO()
    buffer.name = file_name

    file = await bot.get_file(file_id)
    await bot.download_file(file.file_path, buffer)
    buffer.seek(0)



    # ---- –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª, —Ç–æ –∂–¥—ë–º –≤—Ç–æ—Ä–æ–π ----
    if next_state != ReqFiles.chatting:
        await message.answer(prompt)
        await state.set_state(next_state)
        return
    elif next_state == ReqFiles.chatting:
        await message.answer(prompt)

        # ---- –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º –¥–∏–∞–ª–æ–≥–∞ ----
        await state.set_state(ReqFiles.chatting)


@user_private_router.message(ReqFiles.chatting)
async def agent_chat(message: types.Message, state: FSMContext):
    pass